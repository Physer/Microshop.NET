name: Continuous Deployment (Template)
concurrency: cd-${{ github.workflow }}

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      service-name:
        required: true
        type: string
    secrets:
      azureClientId:
        required: true
      azureClientSecret:
        required: true
      azureSubscriptionId:
        required: true
      azureTenantId:
        required: true
  workflow_run:
    workflows: [continuous_integration, deploy_generic_resources]
    types: completed

jobs:
  prepare_aks_credentials:
    if: ${{ github.event.continuous_integration.conclusion == 'success' }} && ${{ github.event.deploy_generic_resources.conclusion == 'success' }}
    name: Prepare AKS deployment credentials
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: azure/setup-kubectl@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.azureClientId }}","clientSecret":"${{ secrets.azureClientSecret }}","subscriptionId":"${{ secrets.azureSubscriptionId }}","tenantId":"${{ secrets.azureTenantId }}"}'

      - name: Set AKS context
        uses: azure/aks-set-context@v3
        with:
          resource-group: "rg-microshop-${{ inputs.environment }}"
          cluster-name: "aks-microshop-${{ inputs.environment }}"

  deploy:
    name: Deploy ${{ inputs.service-name }} to the ${{ inputs.environment }} environment
    environment: ${{ inputs.environment }}
    needs: prepare_aks_credentials
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure/kubernetes
    steps:
      - uses: actions/checkout@v3

      - run: kubectl apply -f ${{ inputs.service-name }}.yaml
